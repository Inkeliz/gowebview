package network

import (
	"net"
	"net/url"
)

var privateIPBlock = []*net.IPNet{
	{
		IP:   []byte{0x7f, 0x00, 0x00, 0x00},
		Mask: []byte{0xff, 0x00, 0x00, 0x00},
	},
	{
		IP:   []byte{0x0a, 0x00, 0x00, 0x00},
		Mask: []byte{0xff, 0x00, 0x00, 0x00},
	},
	{
		IP:   []byte{0xac, 0x10, 0x00, 0x00},
		Mask: []byte{0xff, 0xf0, 0x00, 0x00},
	},
	{
		IP:   []byte{0xc0, 0xa8, 0x00, 0x00},
		Mask: []byte{0xff, 0xff, 0x00, 0x00},
	},
	{
		IP:   []byte{0xa9, 0xfe, 0x00, 0x00},
		Mask: []byte{0xff, 0xff, 0x00, 0x00},
	},
	{
		IP:   []byte{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01},
		Mask: []byte{0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
	},
	{
		IP:   []byte{0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		Mask: []byte{0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	},
	{
		IP:   []byte{0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		Mask: []byte{0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	},
}

// IsPrivateNetworkString is a wrapper of `IsPrivateNetwork`. It verifies if the given IP or Host is on private network
// range. It will return true for IPs such as 127.0.0.1, 192.0.0.1 or https://127.0.0.1 and so on.
//
// Be aware that it doesn't check if the host is point against private network. It DOESN'T verifies the DNS. So, suppose
// that you give `https://local.network.com` (which as some DNS to `127.0.0.1`), it will return FALSE. It will only works
// if the host contains the IP, such as https://127.0.0.1.
func IsPrivateNetworkString(uri string) bool {
	ip := net.ParseIP(uri)
	if ip != nil {
		return IsPrivateNetwork(ip)
	}

	u, err := url.Parse(uri)
	if err != nil {
		return false
	}

	ip = net.ParseIP(u.Hostname())
	if ip == nil {
		return false
	}

	return IsPrivateNetwork(ip)
}

// IsPrivateNetwork verifies if the given IP is on private network range. It will return true for IPs such as 127.0.0.1,
// or 192.0.0.1.
func IsPrivateNetwork(ip net.IP) bool {
	for _, cidr := range privateIPBlock {
		if cidr.Contains(ip) {
			return true
		}
	}

	return false
}
